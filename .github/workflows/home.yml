name: STABLE_FINAL

on:
  workflow_dispatch:
  schedule:
    # Backup trigger setiap 5.5 jam kalau auto re-trigger gagal
    - cron: "30 */5 * * *"

# Cegah duplikat â€” hanya 1 instance jalan sekaligus
concurrency:
  group: rdp-session
  cancel-in-progress: false

jobs:
  rdp-session:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”‘ Generate Credentials
        id: creds
        run: |
          $chars = ([char[]]('a'..'z') + [char[]]('A'..'Z') + [char[]]('0'..'9'))
          $pass = -join (1..20 | ForEach-Object { $chars | Get-Random })
          echo "::add-mask::$pass"
          $secPass = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name "Pro_Admin" -Password $secPass -AccountNeverExpires -ErrorAction SilentlyContinue
          Set-LocalUser -Name "Pro_Admin" -Password $secPass
          Add-LocalGroupMember -Group "Administrators" -Member "Pro_Admin" -ErrorAction SilentlyContinue
          echo "PASS=$pass" >> $env:GITHUB_OUTPUT

      - name: ğŸŒ Deploy Tailscale
        id: network
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "ts.msi", "/quiet", "/norestart" -Wait
          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
          & $ts up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=PRO-RDP-$(Get-Random -Minimum 1000 -Maximum 9999)
          $ip = & $ts ip -4
          echo "IP=$ip" >> $env:GITHUB_OUTPUT
          echo "::notice::Tailscale IP = $ip"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NOTIFY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¤ Send Telegram Notification
        run: |
          $uptime = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
          $msg = @"
          ğŸ’ mamanher SESSION ACTIVE

          ğŸš€ Host: ${{ steps.network.outputs.IP }}
          ğŸ‘¤ User: Pro_Admin
          ğŸ”‘ Pass: ${{ steps.creds.outputs.PASS }}
          ğŸ• Started: $uptime
          â±ï¸ Max Duration: ~5h 50m

          âš¡ @TipsUNIX
          "@

          $body = @{
            chat_id = "${{ secrets.TELEGRAM_CHAT_ID }}"
            text    = $msg.Trim()
          } | ConvertTo-Json -Depth 3

          Invoke-RestMethod -Uri "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" `
            -Method Post -Body $body -ContentType "application/json; charset=utf-8"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ KEEP ALIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â³ Keep-Alive (350 min)
        run: |
          $end = (Get-Date).AddMinutes(350)
          $i = 0
          while ((Get-Date) -lt $end) {
            $i++
            $remaining = [math]::Round(($end - (Get-Date)).TotalMinutes)
            if ($i % 30 -eq 0) {
              Write-Host "ğŸŸ¢ Alive â€” $remaining min remaining"
            }
            Start-Sleep -Seconds 60
          }
          Write-Host "â° Session ending, preparing restart..."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CLEANUP & RESTART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¹ Cleanup Tailscale
        if: always()
        run: |
          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (Test-Path $ts) { & $ts logout }

      - name: ğŸ”„ Auto Re-trigger (24/7 loop)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "â™»ï¸ Triggering next session..."
          $headers = @{
            "Authorization" = "Bearer $env:GH_TOKEN"
            "Accept"        = "application/vnd.github+json"
          }
          $uri = "https://api.github.com/repos/${{ github.repository }}/actions/workflows/home.yml/dispatches"
          $body = '{"ref":"main"}'

          # Retry 3x in case of transient failure
          for ($attempt = 1; $attempt -le 3; $attempt++) {
            try {
              Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body -ContentType "application/json"
              Write-Host "âœ… Next session triggered (attempt $attempt)"
              break
            } catch {
              Write-Host "âš ï¸ Attempt $attempt failed: $_"
              Start-Sleep -Seconds 10
            }
          }
